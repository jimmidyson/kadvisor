machine:
  services:
    - docker

checkout:
  post:
    - ([[ "$CIRCLE_BRANCH" = pull/* ]] && git merge --no-ff master) || [[ "$CIRCLE_BRANCH" != pull/* ]]
    - rm -rf ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - mkdir -p ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - ln -s $(pwd) ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/$(basename `pwd`)

dependencies:
  pre:
    - make deps
  override:
    - make

test:
  override:
    - cd ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME} && ./coverage.sh --coveralls
    - |
      formatted="$(go fmt ./...)" && \
      ( ( [[ -n $formatted ]] && echo "gofmt failed on the following files:" && echo -ne $formatted && exit 1) || (( [[ -z $formatted ]] && echo "gofmt passed")  ) )

