machine:
  services:
    - docker

checkout:
  post:
    - ([[ "$CIRCLE_BRANCH" = pull/* ]] && git merge --no-ff master) || [[ "$CIRCLE_BRANCH" != pull/* ]]
    - rm -rf ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - mkdir -p ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - cp -R $(pwd) ${GOPATH%%:*}/src/github.com/${CIRCLE_PROJECT_USERNAME}/

dependencies:
  pre:
    - go get github.com/tools/godep
    - go get golang.org/x/tools/cmd/cover
    - go get github.com/mattn/goveralls
  override:
    - make

test:
  override:
    - ./coverage.sh --coveralls
    - |
      formatted="$(go fmt ./...)" && \
      ( ( [[ -n $formatted ]] && echo "gofmt failed on the following files:" && echo -ne $formatted && exit 1) || (( [[ -z $formatted ]] && echo "gofmt passed")  ) )

